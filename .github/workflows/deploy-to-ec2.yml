name: Deploy to EC2 via S3 and SSM

on:
  push:
    branches: [main]

env:
  AWS_REGION: ap-southeast-5
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

jobs:
  deploy-to-s3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync . s3://${{ env.S3_BUCKET_NAME }} \
            --exclude ".git*" \
            --exclude ".github/*" \
            --delete

  deploy-to-ec2-via-ssm:
    runs-on: ubuntu-latest
    needs: deploy-to-s3
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Send SSM Run Command
        id: send-command
        run: |
          # 同步文件并验证
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "i-0ca6efb1cf27fa86b" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "echo === 开始同步文件 ===",
              "sudo aws s3 sync s3://'${{ env.S3_BUCKET_NAME }}' /var/www/html --delete",
              "echo === 同步完成，显示文件列表 ===",
              "sudo ls -la /var/www/html/",
              "echo === 显示前几个文件 ===",
              "sudo ls /var/www/html/ | head -20",
              "echo === 检查 web 服务是否运行 ===",
              "sudo systemctl status httpd || sudo systemctl status nginx || echo 未找到常见web服务",
              "echo === 完成 ==="
            ]' \
            --output text --query "Command.CommandId")
          echo "Command ID: $COMMAND_ID"
          echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_OUTPUT

      - name: Wait for command execution
        run: sleep 20

      - name: Check command execution status and output
        run: |
          echo "=== 获取命令执行结果 ==="
          aws ssm get-command-invocation \
            --command-id "${{ steps.send-command.outputs.COMMAND_ID }}" \
            --instance-id "i-0ca6efb1cf27fa86b" \
            --query "StandardOutputContent" \
            --output text
